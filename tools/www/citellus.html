<!DOCTYPE html>
<html>
 <head>
  <title>Citellus</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css">
  <style>
    pre {
         white-space: pre-wrap;
    }
    #cat_list {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }
    #accordion {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }
    .alert strong {
        text-transform: capitalize;
    }
  </style>
 </head>
 <body>
  <div class="container">
   <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="https://github.com/zerodayz/citellus"><img src="https://raw.githubusercontent.com/zerodayz/citellus/master/doc/citellus.png" width="30" height="30" alt=""> Citellus</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
     <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
     <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a class="nav-link" target="_blank" href="https://github.com/zerodayz/citellus/blob/master/README.md">Usage Doc</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" target="_blank" href="https://github.com/zerodayz/citellus/tree/master/doc">Plugin Development</a>
      </li>
      <li class="nav-item">
       <a class="nav-link" target="_blank" href="https://github.com/zerodayz/citellus/blob/master/CONTRIBUTING.md">Contribute</a>
      </li>
     </ul>
     <form class="form-inline my-2 my-lg-0">
      <input type="search" class="form-control mr-sm-2" id="filter_text" placeholder="Search for plugin" aria-label="Search for plugin">
     </form>
    </div>
   </nav>
   <div id="alert_list"></div>
   <div class="row">
     <div class="col-sm">
      <table id="metadata_table" class="table table-hover table-bordered">
        <thead>
         <tr><th colspan=2 class="text-center">Runtime Metadata</th></tr>
        </thead>
        <tbody>
        </tbody>
       </table>
      </div> <!-- /col -->
     </div> <!-- /row -->
     <div class="row">
      <div class="col-sm">
       <input type="hidden" id="filter_status" value="all">
	   <div class="btn-group" role="group" aria-label="Status Filters">
	    <button type="button" class="btn btn-success filter-status" data-filter="okay">okay</button>
	    <button type="button" class="btn btn-danger filter-status" data-filter="failed">failed</button>
	    <button type="button" class="btn btn-warning filter-status" data-filter="skipped">skipped</button>
        <button type="button" class="btn btn-dark filter-status" data-filter="all">all</button>
	   </div><!-- /btn-group -->
      </div><!-- /col -->
      <div class="col-sm">
       <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#cat_list" aria-expanded="false" aria-controls="cat_list">Categories</button>
       <button type="button" class="btn btn-secondary" id="expandAll">Expand All</button>
      </div><!-- /col -->
     </div><!-- /row -->
     <div class="row">
      <div class="col-sm">
       <div class="collapse" id="cat_list"></div>
     </div><!-- /col -->
    </div><!-- /row -->
    <div id="accordion" role="tablist"></div>
  </div> <!-- /container -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
  <script>
   var ft_min_char = 3;
   // function that filters the unique values of an array
   function onlyUnique(value, index, self) {
       return self.indexOf(value) === index;
   }
   // function to either check or uncheck all categories
   function checkAllCat(checked) {
       $(".check-category").each(function(i,j) {
           $(this).prop("checked",checked);
           checkThisCat($(this));
       });
       $("#check_all").prop("checked",checked);
       filterCards();
   }
   // function to set the correct colors on checkbox
   function checkThisCat(cb) {
         if (cb.prop("checked")) {
              cb.parent().removeClass("btn-danger").addClass("btn-primary");
          } else {
              cb.parent().removeClass("btn-primary").addClass("btn-danger");
          }

   }

   // function that applies all possible filters.
   // it's called whenever a filter is triggered.
   function filterCards() {
       var filter_status = $("#filter_status").val();
       var filter_text = $("#filter_text").val();
       var filter_category = "";
       $(".check-category").each(function(i,j) {
           if ($(this).prop("checked")) {
             filter_category += $(this).attr("name") + "|";
           }
        });
        filter_category = filter_category.slice(0, -1);
        var cb_regex = new RegExp(filter_category);
        $("#accordion > div").each(function(i,j) {
           var plugin_cats = $(this).data("categories");
           var plugin_txt = $(this).children('.plugin-error').first().text();
           var plugin_name = $(this).data("plugin-name");
           var plugin_status = $(this).data("state");
           // Validations:
           // - if plugin categories match regex of checked categories
           // - if plugin state match status filter
           // - if plugin (name|text) match text filter, only if there's at least $ft_min_char char
            if (cb_regex.test(plugin_cats) && (filter_status == "all" || filter_status == $(this).data("state")) && (filter_text.length < ft_min_char || (filter_text.length >= ft_min_char && (plugin_txt && plugin_txt.toLowerCase().indexOf(filter_text) != -1) || (plugin_name && plugin_name.toLowerCase().indexOf(filter_text) != -1)))) {
             $(this).show();
            } else {
             $(this).hide();
            }
        });
   }
   function warnMessage(level,m) {
      var html = '<div class="alert alert-'+level+' alert-dismissible fade show" role="alert"><strong>'+level+'</strong> '+m+' <button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span></button></div>';
      $("#alert_list").append(html);
   }
   $(document).ready(function() {
    var url_file_regex = new RegExp("^file:\/\/");
    if (window.chrome && window.chrome.webstore && url_file_regex.test(window.location.href)) {
        warnMessage("warning","Some browsers (ie: Chrome) are not accepting file:// URLs. Firefox supports it, or you can start Chrome with --allow-file-access-from-files");
    }
    // for some unknown reason, this is broken
    $("#expandAll").click(function(e) {
       $(".collapse").each(function(i,o) {
		console.log($(this));
		$(this).collapse("show");
	   });
    });

    // listener when the user picks a status filter
    $(".filter-status").click(function(e){
        $("#filter_status").val($(this).data("filter"));
        filterCards();
    });
    // listener when the user writes in the searchbox
	$("#filter_text").keyup(function(e) {
        filterCards();
	});

    // In this section, we have to attach events on the body
    // because we are using dynamic elements

    // listener when the user clicks on category check boxes
    $("body").on("change",".check-category",function() {
         checkThisCat($(this));
         filterCards();
    });
    // listener when the user checks or uncheck the "All categories"
    $("body").on("change","#check_all",function() {
        var cb = $(this);
        checkAllCat(cb.prop("checked"));
    });
    // listener when someone is clicking on a badge in an expanded card
    $("body").on("click",".category-badge",function() {
        var cat = $(this).data("category");
        checkAllCat(false);
        $("#cb_cat_"+cat).prop("checked",true).change();
    });

    // Here we load the data from citellus.json with ajax and we populate the webpage
    $.ajax({
       // This is hardcoded for now
       url: "citellus.json",
       dataType: "json",
       async: true,
       error: function(jqXHR, exception) {
           if (jqXHR.status === 0) {
               warnMessage("danger","Unable to get JSON file. [0]");
           } else if (jqXHR.status == 404) {
               warnMessage("danger","File not found. [404]");
           } else if (jqXHR.status == 500) {
               warnMessage("danger","Internal Server Error [500].");
           } else if (exception === "parsererror") {
               warnMessage("danger","Requested JSON parse failed.");
           } else if (exception === "timeout") {
               warnMessage("danger","Time out error.");
           } else if (exception === "abort") {
               warnMessage("danger","Ajax request aborted.");
           } else {
               warnMessage("danger","Uncaught Error.\n" + jqXHR.responseText);
           }
       },
       success: function(data) {
        // We need to generate some kind of plugin id with the filename
        var plugin_re = /plugins\/[^\/]+\/(.*)\/([^\/]+)\.[a-z0-9]+$/;
        var bz_re = /\_([0-9]{7})$/;
        $.each(data.metadata, function(i, item) {
            var row = '<tr><th>'+i+'</th><td>'+item+'</td></tr>\n';
            $("#metadata_table > tbody:last-child").append(row);
        });
        var plugin_cats_array = new Array();
        var dataNum = data.results.length;
        var counter = 0;
        $.each(data.results, function(i, item) {

            // Grabbing the name of the plugin off the filename
            var plugin_name = plugin_re.exec(item.plugin)[2];
            var plugin_long_name;
            if (/[a-z0-9]+/.test(item.long_name) && !/^undefined$/.test(item.long_name)) {
                plugin_long_name = item.long_name;
            } else {
                plugin_long_name = plugin_name;
            }
            // Taking all the categories and we make an array out of it
            var plugin_cat = plugin_re.exec(item.plugin)[1];
            var plugin_cats = plugin_cat.split("/");
            var plugin_icon, plugin_state;
            var plugin_cats_visual = "";
            var plugin_cats_list = "";

            // This counter will let us know when we are done looping
            // We need this because JS is async
            counter++;

            // Here we generate the list of category, visual list with badges, as well as comma-separated for the data-attribute
            $.each(plugin_cats, function(c, cname) {
             plugin_cats_visual += '<a href="#" data-category="'+cname+'" class="badge badge-primary category-badge">'+cname+'</a> ';
             plugin_cats_list += cname+',';
             plugin_cats_array.push(cname);
            });

            // We remove the last comma
            plugin_cats_list = plugin_cats_list.slice(0, -1);
            if (counter == dataNum) {
             // Here we are done with looping all the results, we are going to update the filters above
             var unique = plugin_cats_array.filter( onlyUnique );
             // We generate the category filters here
             var div_cat_list = '<div class="row"><label class="btn btn-dark active" style="width: 100%"><input type="checkbox" id="check_all" checked autocomplete="off">All</label></div><div class="row">\n';
             $.each(unique,function(c, cname) {
                 div_cat_list += ' <div class="col-md-3"><label class="btn btn-primary active"><input type="checkbox" name="'+cname+'" id="cb_cat_'+cname+'" class="check-category" data-category="'+cname+'" checked autocomplete="off">'+cname+'</label></div>\n';
             });
             div_cat_list += '</div>';
             $("#cat_list").html(div_cat_list);
            }

            // We set some variables depending on the result or exit code of the plugins
            if (item.result.rc == 30) {
                plugin_icon = "warning"; plugin_state = "skipped"; plugin_class = "warning"; plugin_text_color = "text-black";
            } else if (item.result.rc == 10) {
                plugin_icon = "circle-check"; plugin_state = "okay"; plugin_class = "success"; plugin_text_color = "text-black";
            } else {
                plugin_icon = "ban"; plugin_state = "failed"; plugin_class = "danger"; plugin_text_color = "text-black";
            }

            // Converting the links to html
	     	error_text = item.result.err.replace(/\bhttp[s]*:\/\/([^\s]+)+\b/gi,'<a href="$&" target="_blank">$&</a>');

            // we built the text that is going to be appended to the container
            var row = '<div data-state="'+plugin_state+'" data-categories="'+ plugin_cats_list +'" class="card">\n';
            row += '<textarea class="plugin-error" style="display: none;">'+item.result.err+'</textarea>\n';
            row += '<div class="card-header" role="tab" id="head-'+item.id+'">\n';
            row += ' <div class="row">\n';
            row += '  <div class="col-sm-1"><span class="badge badge-pill badge-'+plugin_class+'">'+plugin_state+'</span></div>\n';
            row += '  <div class="col-sm"><a data-toggle="collapse" href="#'+item.id+'" aria-expanded="true" aria-controls="'+item.id+'" class="'+plugin_text_color+'">'+plugin_long_name+'</a></div>\n';
            row += '  <div class="col-sm-3 text-right">\n'+plugin_cats_visual+'\n</div>\n';
            row += ' </div>\n'; // /row
            row += '</div>\n'; // /header
            row += '<div id="'+item.id+'" class="collapse" role="tabpanel" aria-labelledby="head-'+plugin_name+'" data-parent="#accordion">\n';
            row += ' <div data-plugin-name="'+plugin_name+'" class="card-body">';
            row += '  <h6 class="card-subtitle mb-2 text-muted">'+item.description+'</h6>';
            row += '  <pre><code>'+error_text+'</code></pre>';
            row += ' </div>\n'; // /card-body
            row += ' <div class="card-footer">\n';
            row += '  <div class="row">\n';
            row += '   <div class="col-sm">\n';
            if (/[0-9a-z]+/.test(item.bugzilla)) {
                 row += '   <a href="'+item.bugzilla+'" target="_blank" class="badge badge-danger">Bugzilla</a>';
            } else if (bz_re.test(plugin_name)) {
                 row += '   <a href="https://bugzilla.redhat.com/show_bug.cgi?id='+bz_re.exec(plugin_name)[1]+'" target="_blank" class="badge badge-danger">Bugzilla</a>';
            }
            row += '   </div>\n'; // /col
            row += '   <div class="col-sm-push-1 text-right text-muted"><span class="oi oi-clock" title="Execution time" aria-hidden="true"></span> '+Math.round(item.time * 1000)/1000+'</div>';
            row += '   <div class="col-sm-2 text-right text-muted"><span class="oi oi-fork" title="Backend" aria-hidden="true"></span> '+item.backend+'</div>';
            row += '  </div>\n'; // /row
            row += ' </div>\n'; // /footer
            row += '</div>\n'; // /tabpanel
            row += '</div>\n'; //card
            $("#accordion").append(row);
        });
       }
    });
   });
  </script>
 </body>
</html>
